
;LAST UPDATE: 07.12.2010 savelij

PAGE_RAMSTART	EQU 2				;  

SYSREG_EFF7	EQU 0XEEF7
SET_ADR_CMOS	EQU 0XDEF7
RD_WR_CMOS	EQU 0XBEF7

STEK		EQU 0X3CE0			;2       
WR_1F		EQU STEK+2			;1     1F ( )
RD_1F		EQU WR_1F+1			;1
WR_FF		EQU RD_1F+1			;1     FF
RD_FF		EQU WR_FF+1			;1
BUFF_SECT	EQU RD_FF+1			;2
ADDR_RET	EQU BUFF_SECT+2			;2
REG_C		EQU ADDR_RET+2			;1
REG_B		EQU REG_C+1			;1
REG_F		EQU REG_B+1			;1
REG_A		EQU REG_F+1			;1
REG_L		EQU REG_A+1			;1
REG_H		EQU REG_L+1			;1
BCAF2STEK	EQU REG_H+1			;2

;PUSH_HL		EQU STEK-2			;2
;PUSH_DE		EQU REG_HL-2			;2

; 256 
COPY_BLOCK	REPT 254
		LDI
		ENDM
		JR COPY_BLOCK1
		
		DW 0XFFFF			;   IM2

COPY_BLOCK1	LDI
		LDI
ECOPY_BLOCK	LD A,0XFA			;    
		LD BC,0X77F7
		OUT (C),A			;  5  1  
		LD A,0XFD
		LD B,0XB7
		OUT (C),A			;  2  2  
		RET

WOUT1F		EQU 0X00			;00
WOUT3F		EQU 0X01			;01
WOUT5F		EQU 0X02			;02
WOUT7F		EQU 0X03			;03
WOUTFF		EQU 0X04			;04
WOUTI		EQU 0X05			;05
WIN1F		EQU 0X06			;06
WIN3F		EQU 0X07			;07
WIN5F		EQU 0X08			;08
WIN7F		EQU 0X09			;09
WINFF		EQU 0X0A			;0A
WINI		EQU 0X0B			;0B
WOUTCD		EQU 0X0C			;0C
WOUTCA		EQU 0X0D			;0D
WINHC		EQU 0X0E			;0E
WWRITE_SEC_	EQU 0X0F			;0F
WREAD_SEC_	EQU 0X10			;10
WINI_RET	EQU 0X11			;11

W_DATA		DW W_OUT1F			;00
		DW W_OUT3F			;01
		DW W_OUT5F			;02
		DW W_OUT7F			;03
		DW W_OUTFF			;04
		DW W_OUTI			;05
		DW W_IN1F			;06
		DW W_IN3F			;07
		DW W_IN5F			;08
		DW W_IN7F			;09
		DW W_INFF			;0A
		DW W_INI			;0B
		DW W_OUTCD			;0C
		DW W_OUTCA			;0D
		DW W_INHC			;0E
EW_DATA
		DW WRITE_SEC_			;0F
		DW READ_SEC_			;10
		DW W_INI			;11

TEXT4VIRTDRV	DB 0X16,ZASTV_Y+2,0
		DC "Virtual Drive: "

RST08_WORK	EX (SP),HL
		PUSH AF
		PUSH BC
		LD A,I
		PUSH AF				; I
		LD A,0X3B
		LD I,A				;   
		LD A,1
		OUT (0XBF),A
		LD BC,0X3FF7
		LD A,6
		OUT (C),A
		NOP
		NOP
		LD BC,0X37F7
		LD A,1
		OUT (C),A
		NOP
		NOP
		LD A,(HL)
		LD (STEK),SP
		LD SP,STEK
		PUSH HL				; HL= 
		PUSH DE
		LD HL,(STEK)
		LD DE,REG_C
		INC HL
		INC HL
		LDI
		LDI
		LDI
		LDI
		LDI
		LDI
		LD HL,EXIT_RST08
		PUSH HL				;  
		LD HL,W_DATA
		ADD A,A
		ADD A,L		
		LD L,A
		LD A,(HL)
		INC L
		LD H,(HL)
		LD L,A
		JP (HL)

EXIT_RST08	LD HL,REG_C
		LD DE,(STEK)
		INC DE
		INC DE
		LDI
		LDI
		LDI
		LDI
		LDI
		LDI
		POP DE
		POP HL
		LD SP,(STEK)
		LD A,(HL)
		INC HL
		CP LOW ((EW_DATA-W_DATA)/2)
		JR C,EXIT_RST082
		LD HL,FOR_RET
EXIT_RST082	PUSH HL
		LD BC,0X40F7
		LD HL,DOS_EMUL
		CALL WRPORT_RET
		POP HL
		XOR A
		OUT (0XBF),A
		POP AF
		LD I,A				; I
		POP BC				; BC'
		POP AF				; AF'
		EX (SP),HL			; HL'
		RET

; "A"   0X1F
W_OUT1F		LD A,(REG_A)
		LD (WR_1F),A
		CP 0X10				;00-0F  
		JR NC,W_OUT1F10
		XOR A
		OUT (0X3F),A
		JR INFF_BIT6

W_OUT1F10	CP 0X20				;10-1F  
		JR NC,W_OUT1F20
		IN A,(0X7F)
		OUT (0X3F),A
INFF_BIT6	XOR A
		LD (RD_1F),A
		LD A,0XBF
		LD (RD_FF),A
		RET

W_OUT1F20	CP 0X40				;20-3F     
		JR NC,W_OUT1F40
		IN A,(0X3F)
NAPRAVL		NOP
		OUT (0X3F),A
		JR INFF_BIT6

W_OUT1F40	CP 0X60				;40-5F   
		JR NC,W_OUT1F60
		IN A,(0X3F)
		INC A
		OUT (0X3F),A
		LD A,0X3C
		LD (NAPRAVL),A
		JR INFF_BIT6

W_OUT1F60	CP 0X80				;60-7F   
		JR NC,W_OUT1F80
		IN A,(0X3F)
		DEC A
		OUT (0X3F),A
		LD A,0X3D
		LD (NAPRAVL),A
		JR INFF_BIT6

W_OUT1F80	CP 0XA0				;80-9F   
		JR NC,W_OUT1FA0
		JR INFF_BIT6

W_OUT1FA0	CP 0XC0				;A0-BF   
		JR NC,W_OUT1FD0
		JR INFF_BIT6

INFF_BIT7	XOR A
		LD (RD_1F),A
		LD A,0X7F
		LD (RD_FF),A
		RET

W_OUT1FD0	CP 0XD0				;C0-CF  
		JR NC,W_OUT1FE0
		JR INFF_BIT6

W_OUT1FE0	CP 0XE0				;D0-DF  
		JR NC,W_OUT1FF0
		LD A,2
INDEX		EQU $-1
		XOR 2
		LD (INDEX),A
		LD (RD_1F),A
		LD A,0XBF
		LD (RD_FF),A
		RET

W_OUT1FF0	CP 0XF0				;E0-EF  
		JR C,INFF_BIT6
		JR INFF_BIT6

; "A"   0X3F
W_OUT3F		LD A,(REG_A)
		OUT (0X3F),A
		RET
	
; "A"   0X5F
W_OUT5F		LD A,(REG_A)
		OUT (0X5F),A
		RET
	
; "A"   0X7F
W_OUT7F		LD A,(REG_A)
		OUT (0X7F),A
		RET

; "A"   0XFF
W_OUTFF 	LD A,(REG_A)
		OUT (0XFF),A
		LD (WR_FF),A
		RET

; "A"   (C)
W_OUTCA 	LD A,(REG_C)
		CP 0XFD
		JR NZ,W_OUTC1F
		LD BC,(REG_C)			;   TR-DOS
		OUT (C),A
		RET

;    	
W_OUTC1F	CP 0X1F
		JP Z,W_OUT1F
		CP 0X3F
		JR Z,W_OUT3F
		CP 0X5F
		JR Z,W_OUT5F
		CP 0X7F
		JR Z,W_OUT7F
		JR W_OUTFF

; "D"   (C)
W_OUTCD		LD A,(REG_C)
		CP 0XFD
		JR NZ,W_OUTC1F
W_OUTCD1	LD BC,(REG_C)
		OUT (C),D
		RET
	
; ,  OUTI
W_OUTI		LD HL,(BUFF_SECT)
		EXX
		LD A,(HL)
		INC HL
		EXX
		LD (HL),A
		INC HL
		LD (BUFF_SECT),HL
		RET

;  0X1F	
W_IN1F		LD A,(RD_1F)
		LD (REG_A),A
		RET

;  0X3F
W_IN3F		IN A,(0X3F)
		LD (REG_A),A
		RET
	
;  0X5F
W_IN5F		IN A,(0X5F)
		LD (REG_A),A
		RET

;  0X7F
W_IN7F		IN A,(0X7F)
		LD (REG_A),A
		RET

;  0XFF
W_INFF		LD A,(RD_FF)
		LD (REG_A),A
		RET

;  "H"  ()
W_INHC		LD A,(REG_C)
		CP 0XFD
		JR NZ,W_INHC1
W_INHC0		LD BC,(REG_C)
		IN A,(C)
		LD (REG_H),A
		RET

;    
W_INHC1		CP 0X1F
		JR NZ,W_INHC2
		LD A,(RD_1F)
		LD (REG_H),A
		RET

W_INHC2		CP 0X3F
		JR NZ,W_INHC3
		IN A,(0X3F)
		LD (REG_H),A
		RET
	
W_INHC3		CP 0X5F
		JR NZ,W_INHC4
		IN A,(0X5F)
		LD (REG_H),A
		RET
	
W_INHC4		CP 0X7F
		JR NZ,W_INHC5
		IN A,(0X7F)
		LD (REG_H),A
		RET
	
W_INHC5		LD A,(WR_FF)
		LD (REG_H),A
		RET
	
; INI
W_INI		LD A,(RD_1F)
		LD HL,(REG_L)
		LD (HL),A
		INC HL
		DEC B
		LD (REG_L),HL
		RET

;    
SV_LD_RAMDISK	PUSH HL
		CALL CP_TYPEDRIVE
		POP HL
		JP NZ,WR_NUM_TRACK		;       
		POP HL				;   
		POP HL
		POP BC
		XOR A
		OR B
		RET Z
		PUSH IX				;   
		LD IX,(TRD_5CCE)		;  ? 00-, FF-,    
		DI
SVLDRAM1	PUSH BC
		PUSH HL
		LD DE,(TRD_5CF4)
		CALL COM_04
		LD A,E
		CALL COM_03
		CALL SETPOS_RAMDISK		;      1 
		LD A,0X10
		LD HL,TRD_5CF4
		INC (HL)			;  
		CP (HL)
		JR NZ,SVLDRAM2
		LD (HL),0			;    ,   =0
		INC HL
		INC (HL)			;   
SVLDRAM2	POP HL
		POP BC
		INC H				;    256 
		DJNZ SVLDRAM1
		POP IX				;  
		EI
		RET

WRITE_SEC_	PUSH IX
		LD IXL,0XFF
WRITE_SEC_1	LD HL,(REG_L)
		IN A,(0X3F)
		ADD A,A
		LD D,A
		IN A,(0X5F)
		DEC A
		LD E,A
		LD A,(WR_FF)
		AND 0X10
		JR NZ,READ_SEC_3
		INC D
READ_SEC_3	CALL SETPOS_RAMDISK
		LD A,IXL
		AND A
		JR NZ,READ_SEC_2
		EX DE,HL
READ_SEC_2	LD (REG_L),HL
		POP IX
		RET

READ_SEC_	LD A,(WR_1F)
		CP 0X80
		JP C,INFF_BIT6
		LD HL,(REG_L)
		LD A,H
		CP 0X40
		JR NC,READ_SEC_1
		LD A,1
		ADD A,H
		LD H,A
		LD (REG_L),HL
		POP IX
		RET

READ_SEC_1	PUSH IX
		LD IXL,0
		JR WRITE_SEC_1

;       
; :   HL=/
;	     DE=  
;	    IXL=0-(  ), FF-(  )
SETPOS_RAMDISK	EX DE,HL
		LD A,L				;  
		LD L,H
		LD H,0
		ADD HL,HL
		ADD HL,HL
		ADD HL,HL
		ADD HL,HL			;    4 
		OR L				;  4     
		LD L,A				;     
		ADD HL,HL
		ADD HL,HL			;    4
		LD A,PAGE_RAMSTART		;   
		ADD A,H				;   16 
		LD IXH,A			;       
		LD C,0XF7			;      
		LD B,A				;    
		LD A,D				;  / 
		CP 0X80
		LD A,B				;   
		LD B,0X77			;  32 ,     1  
		JR NC,SP_RAMD1
		LD B,0XB7			;  32 ,     2  
SP_RAMD1	OUT (C),A			;  
		LD B,0X40			;     
		JR NC,SP_RAMD2
		LD B,0X80			;     
SP_RAMD2	LD A,L
		RRCA
		RRCA				;     
		ADD A,B				;   
		LD H,A
		LD L,0				;       256 
		LD A,D
		CP 0X80				;   
		JP NC,SP_RAMD3			;    
		CP 0X7F
		JP C,SP_RAMD3			;     
		LD A,E
		AND A				;     ,   
		JP Z,SP_RAMD3			;     
		LD A,IXL			;  ?
		AND A
		LD A,E				;    
		JR Z,SP_RAMD4
		EX DE,HL			;   
SP_RAMD4	NEG
		LD C,A				;    
		LD B,0
		LDIR
		NEG
		EX AF,AF'			;       
		LD A,0XFD
		LD BC,0XB7F7
		OUT (C),A			;     2  
		LD B,0X77
		LD A,IXH
		OUT (C),A			;    1  
		LD A,IXL			;  
		AND A
		JR Z,SP_RAMD5
		LD A,D				; 
		SUB 0X40			;       
		LD D,A
		JR SP_RAMD6

SP_RAMD5	LD A,H				;   
		SUB 0X40			;        
		LD H,A
SP_RAMD6	EX AF,AF'
		LD C,A				;   
		LD B,0
		LDIR
		JP ECOPY_BLOCK			;   

SP_RAMD3	LD A,IXL			;  
		AND A
		JP Z,COPY_BLOCK
		EX DE,HL			;   
		JP COPY_BLOCK

; : H- 
;	   L- 
READCMOS	PUSH BC
		LD A,1
		OUT (0XBF),A
		LD BC,SET_ADR_CMOS
		OUT (C),H
		LD B,HIGH (RD_WR_CMOS)
		IN L,(C)
		JR OFF_CMOS

; : H- 
;	   L-  
WRITECMOS	PUSH BC
		LD A,1
		OUT (0XBF),A
		LD BC,SET_ADR_CMOS
		OUT (C),H
		LD B,HIGH (RD_WR_CMOS)
		OUT (C),L
OFF_CMOS	POP BC
		XOR A
		OUT (0XBF),A
		LD A,L
		AND A
		RET

CP_TYPEDRIVE	PUSH HL
		LD H,0X0F
		CALL READCMOS
		LD A,(TRD_5CF6)
		CP L
		POP HL
		RET

SET_DRIVENAME	LD H,0X10
		CALL READCMOS
		AND 3
		LD (TRD_5D19),A
		LD (TRD_5CF6),A
		OR 0X3C
		RET

FORMAT_RAM	CALL CP_TYPEDRIVE
		RET NZ
		LD A,1
		LD BC,0XBFF7
		OUT (C),A
		LD HL,0X8000
		LD DE,0X8001
		LD BC,0XFFF
		LD (HL),L
		LDIR
		CALL ECOPY_BLOCK
		XOR A
		RET
